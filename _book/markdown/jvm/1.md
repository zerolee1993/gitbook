> **我们所面临的问题**
>
> - 如何处理生产环境下的内存溢出
> - 如何处理生产环境下 CPU 负载飙升
> - 给生产服务器分配多少内存
> - 给生产应用分配多下线程
> - 如何针对垃圾处理器性能进行调优
> - 不加 log 情况下如何确定是否执行了某行代码
> - 不加 log 情况下如何实时查看某方法入参及返回值
> - 了解 JVM 的字节码、字节码指令
> - 为何循环体中做字符串 + 拼接效率低下
> - 字符串 + 拼接一定是 StringBuilder.append 吗
> - 了解 String 常量池是何物
> - 了解 i++ 与 ++i 哪种写法效率高
> - 熟练使用各种监控和调试工具
> - 理解 JVM 自动内存回收机制，学会 GC 调优

- 基于 JDK 命令行工具的监控
  - JVM 参数类型
  - 查看运行时 JVM 参数
  - 查看 JVM 统计信息
  - jmap + MAT 实战内存溢出
  - jstack 实现死循环与死锁
- 基于 JVisualVM 的可视化监控
  - 监控本地 Java 进程
  - 监控远程 Java 进程
- 基于 Btrace 的监控调试
  - Btrace 安装使用入门
  - Btrace 使用详解
- Tomcat 性能监控与调优
  - Tomcat 远程 debug 测试环境 linux 下的代码
  - Tomcat-manager 监控 Tomcat
  - psi-probe 监控 Tomcat
  - Tomcat 调优
- Nginx 性能监控与调优
  - ngx_http_stub_status 监控连接信息
  - ngxtop 监控请求信息
  - nginx-rrd 图形化监控
  - nginx 调优
- JVM 层 GC 调优
  - JVM 内存结构
  - 垃圾回收算法
  - 垃圾收集器
  - GC 日志格式与可视化日志分析工具
  - Tomcat 的 GC 调优实战
- Java 代码层优化
  - 字节码执行与 javap
  - i++ 与 ++i ，字符串 + 拼接的原理
  - 常用代码优化方法

## 基于JDK命令行工具的监控

JVM的参数类型
- 标准参数
  - -help
  - -server -client
  - -version -showversion
  - -cp -classpath
- X参数
  - 非标准化参数
  - -Xint 解释执行
  - -Xcomp 第一次使用就编译成本地代码
  - -Xmixed 混合模式，JVM自己决定是否编译成本地代码
- XX参数
  - 非标准化参数
  - 相对不稳定
  - 主要用于JVM调优和Debug

- XX参数分类
  - Boolean类型
    - -XX:[+-]<name>表示启用或禁用name属性
    - -XX:+UseConcMarkSweepGC 启用CMS垃圾回收器
    - -XX:+UseG1GC 启用G1垃圾回收器
  - 非Boolean类型
    - -XX:<name>=<value>表示name属性的值是value
    - -XX:MaxGCPauseMillis=500 GC的最大停顿时间为500ms
    - -XX:GCTimeRatio=19
    - -Xms 等价于 -XX:InitialHeapSize
    - -Xmx 等价于 -XX:MaxHeapSize

  ```
[root@localhost apache-tomcat-8.5.32]# jinfo -flag MaxHeapSize 7842
-XX:MaxHeapSize=264241152
[root@localhost apache-tomcat-8.5.32]# jinfo -flag ThreadStackSize 7842
-XX:ThreadStackSize=320
  ```

### 运行时JVM参数查看

- -XX:+PrintFlagsInitial 查看初始值
- -XX:+PrintFlagsFinal 查看修改值
- -XX:+UnlockExperimentalVMOptions 解锁实验参数
- -XX:+UnlockDiagnosticVMOptions 解锁诊断参数
- -XX:+PrintCommandLineFlags 打印命令行参数

```
# =表示默认值，:=表示被用户或JVM修改后的值
java -XX:+PrintFlagsFinal -version > flags.txt
```

### jps 查看java进程
```
[root@localhost ~]# jps
7842 Bootstrap
9980 Jps
[root@localhost ~]# jps -l
7842 org.apache.catalina.startup.Bootstrap
9993 sun.tools.jps.Jps
```

### jinfo 查看进程的JVM参数
- Non-default表示手动赋值后的参数
- Command line命令行传递的参数
```
[root@localhost ~]# jinfo -flag MaxHeapSize 7842
-XX:MaxHeapSize=264241152
[root@localhost ~]# jinfo -flags 7842
Attaching to process ID 7842, please wait...
Debugger attached successfully.
Client compiler detected.
JVM version is 25.181-b13
Non-default VM flags: -XX:InitialHeapSize=16777216 -XX:MaxHeapSize=264241152 -XX:MaxNewSize=88080384 -XX:MinHeapDeltaBytes=131072 -XX:NewSize=5570560 -XX:OldSize=11206656 -XX:+UseFastUnorderedTimeStamps
Command line:  -Djava.util.logging.config.file=/usr/local/apache-tomcat-8.5.32/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -Dcatalina.base=/usr/local/apache-tomcat-8.5.32 -Dcatalina.home=/usr/local/apache-tomcat-8.5.32 -Djava.io.tmpdir=/usr/local/apache-tomcat-8.5.32/temp
[root@localhost ~]# jinfo -flag UseConcMarkSweepGC 7842
-XX:-UseConcMarkSweepGC
[root@localhost ~]# jinfo -flag UseG1GC 7842
-XX:-UseG1GC
[root@localhost ~]# jinfo -flag UseParallelGC 7842
-XX:-UseParallelGC
```

### jstat查看JVM统计信息

类装载
- 1000毫秒刷新一次，共打印十次
```
[root@localhost ~]# jstat -class 7842 1000 10
Loaded  Bytes  Unloaded  Bytes     Time
  2704  2789.5        0     0.0       1.43
  2704  2789.5        0     0.0       1.43
  2704  2789.5        0     0.0       1.43
  2704  2789.5        0     0.0       1.43
  2704  2789.5        0     0.0       1.43
  2704  2789.5        0     0.0       1.43
  2704  2789.5        0     0.0       1.43
  2704  2789.5        0     0.0       1.43
  2704  2789.5        0     0.0       1.43
  2704  2789.5        0     0.0       1.43
```
垃圾收集
- -gc
```
[root@localhost ~]# jstat -gc 7842 1000 3
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
896.0  896.0   0.0    0.0    7616.0   1091.6   18684.0    13020.4   10264.0 10077.2  0.0    0.0       40    0.327   1      0.021    0.347
896.0  896.0   0.0    0.0    7616.0   1091.6   18684.0    13020.4   10264.0 10077.2  0.0    0.0       40    0.327   1      0.021    0.347
896.0  896.0   0.0    0.0    7616.0   1238.0   18684.0    13020.4   10264.0 10077.2  0.0    0.0       40    0.327   1      0.021    0.347
```
  - S0C、S1C、S0U、S1U：S0和S1的总量与使用量
  - EC、EU：Eden区总量与使用量
  - OC、OU：Old区总用量与使用量
  - MC、MU：Metaspace区总量与使用量
  - CCSC、CCSU：压缩类空间总量与使用量
  - YGC、YGCT：YoungGC的次数与时间
  - FGC、FGCT：FullGC的次数与时间
  - GCT：总的GC时间
- -gcutil
- -gccause
- -gcnew
- -gcold
- ...参考文档有很多

### JVM的内存结构

![png](image/1-1.png)

### JIT编译

- -compiler
- -printcompilation
```
[root@localhost apache-tomcat-8.5.32]# jstat -compiler 1947
Compiled Failed Invalid   Time   FailedType FailedMethod
     718      0       0     0.29          0
```

## jmap+MAT实战内存溢出
官方项目生成器：https://start.spring.io/

无限循环向list中添加数据

将-Xmx -Xms都设置为32M


## jstack实战死循环有死锁
