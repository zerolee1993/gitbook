## 基本架构

![MySQL 逻辑架构图](asset/structure.png)

MySQL 可以分为 Server 层和存储引擎层

- Server 层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖 MySQL 的大多出核心服务功能，以及内置函数，所有跨存储引擎的功能都在这一层实现，比如存储过程，触发器，视图等。
- 存储引擎层负责数据的存储和提取。其架构模式是插件式的，支持 InnoDB、MyISAM、Memory 等多个存储引擎。现在最常用的存储引擎是 InnoDB，它从 MySQL 5.5.5 版本开始成为默认存储引擎。

> 在《高性能 MySQL》中作者给出了三层架构，与此类似，另外，MySQL 官网也给出了架构图，三者各有异同，之后了解 MySQL 源码时可深入理解

---

## 连接器

连接过程

- 可以在终端中通过如下命令建立 MySQL 连接

  ```
  mysql -h 127.0.0.1 -P 3306 -u root -p
  ```

- 这里使用的 mysql 是客户端工具，用于与 MySQL 服务端建立连接

- 连接器对用户名密码认证通过后，会到权限表中查询用户的权限，之后此连接中的所有请求都依赖于此时查询到的权限
- 连接成功建立后，用户权限被修改，并不会影响已经建立的连接

- 连接后若无动作，连接处于空闲状态，可使用 show full processlist 查看，Command 为 Sleep
- 如果超过某一时间无动作，讲自动断开，这个超时时间通过参数 wait_timeout 控制，默认为 8 h
- 超时后再次发送请求将收到错误提醒：Lost connection to MySQL server during query

长连接与短连接

- 长连接：客户端持续有请求，一直使用一个连接
- 短连接：连接后执行少量查询就断开
- 减少建立连接过程中的损耗，尽量使用长连接
- 但全部使用长连接，可能会导致 MySQL 使用内存突增，是由于 MySQL 执行过程中的内存是管理在连接对象中的，某些资源只会在断开连接时释放，长连接累计下来的资源内存占用可能会导致 OOM，使 MySQL 异常重启
- 定期断开长连接，使用一段时间，或者程序里判断执行过一个占用内存大的查询后，断开连接
- 如果版本 >= 5.7，可以通过执行 mysql_reset_connection 来重新初始化连接资源，不需要重连

> 关于连接的控制，可多了解下连接池

---

## 查询缓存

- 完成连接后，select 语句会优先判断查询缓存中是否有对应的结果，如果有直接返回

- 查询缓存是以 key-value 的形式缓存在内存中的

- 针对表的更新会使表中的查询缓存全部失效

- 不建议使用查询缓存，除非是一张静态表

- query_cache_type 参数用于控制是否开启查询缓存，当设置为 DEMAND 时，可以通过 SQL_CACHE 显示的指定使用查询缓存

  ```
  select SQL_CACHE * from T where id = 1
  ```

- 8.0 版本中查询缓存功能全部删除

---

## 分析器

未命中查询缓存的语句，将继续进行词法分析、语法分析

---

## 优化器

通过优化器，决定使用哪个索引、多个表连接时的连接顺序

---

## 执行器

调用存储引擎接口进行查询，比如如下查询执行器的执行过程

```
select * from T where id = 1;
```

- 调用存储引擎取表第一行，判断 id 是否为 1，若不是则跳过，若是则存入结果集
- 调用存储引擎取下一行，重复如上逻辑
- 将遍历过程中国满足条件的行组成的结果集返回客户端

慢查询日志中的 rows_examined 是在每次调用存储引擎时累加的，表示调用存储引擎的次数，并不是实际扫描的行数，因为有些场景执行器调用一次，引擎内部扫描了多行

